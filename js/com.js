function initialize(){var a={zoom:4,center:new google.maps.LatLng(50,-50)};map=new google.maps.Map(document.getElementById("map-canvas"),a),google.maps.event.addListener(map,"idle",checkIfDataRequested),map.data.addListener("click",function(a){infowindow.setContent("<img src="+a.feature.getProperty("icon")+"><br /><strong>"+a.feature.getProperty("city")+"</strong><br />"+a.feature.getProperty("temperature")+"&deg;C<br />"+a.feature.getProperty("weather")),infowindow.setOptions({position:{lat:a.latLng.lat(),lng:a.latLng.lng()},pixelOffset:{width:0,height:-15}}),infowindow.open(map)})}var map,geoJSON,request,gettingData=!1,openWeatherMapKey="13ee6543faae4f2022c03420fd21df38",checkIfDataRequested=function(){for(;gettingData===!0;)request.abort(),gettingData=!1;getCoords()},getCoords=function(){var a=map.getBounds(),b=a.getNorthEast(),c=a.getSouthWest();getWeather(b.lat(),b.lng(),c.lat(),c.lng())},getWeather=function(a,b,c,d){gettingData=!0;var e="http://api.openweathermap.org/data/2.5/box/?bbox="+d+","+a+","+b+","+c+","+map.getZoom()+"&cluster=yes&format=json&APPID="+openWeatherMapKey;request=new XMLHttpRequest,request.onload=proccessResults,request.open("get",e,!0),request.send()},proccessResults=function(){console.log(this);var a=JSON.parse(this.responseText);if(a.list.length>0){resetData();for(var b=0;b<a.list.length;b++)geoJSON.features.push(jsonToGeoJson(a.list[b]));drawIcons(geoJSON)}},infowindow=new google.maps.InfoWindow,jsonToGeoJson=function(a){var b={type:"Feature",properties:{city:a.name,weather:a.weather[0].main,temperature:a.main.temp,min:a.main.temp_min,max:a.main.temp_max,humidity:a.main.humidity,pressure:a.main.pressure,windSpeed:a.wind.speed,windDegrees:a.wind.deg,windGust:a.wind.gust,icon:"http://openweathermap.org/img/w/"+a.weather[0].icon+".png",coordinates:[a.coord.lon,a.coord.lat]},geometry:{type:"Point",coordinates:[a.coord.lon,a.coord.lat]}};return map.data.setStyle(function(a){return{icon:{url:a.getProperty("icon"),anchor:new google.maps.Point(25,25)}}}),b},drawIcons=function(a){map.data.addGeoJson(geoJSON),gettingData=!1},resetData=function(){geoJSON={type:"FeatureCollection",features:[]},map.data.forEach(function(a){map.data.remove(a)})};google.maps.event.addDomListener(window,"load",initialize);
